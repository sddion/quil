#include "WeatherManager.h"
#include "StatusIcons.h"
#include "hal/h/Display.h"
#include <Adafruit_SSD1306.h>
#include <Adafruit_GFX.h>

// Battery icon bitmaps (24x16 pixels)
static const unsigned char PROGMEM battery_10_bits[] = {
  0x00,0x00,0x00,0x0f,0xff,0xfe,0x10,0x00,0x01,0x10,0x00,0x05,0x70,0x00,0x05,
  0x80,0x00,0x05,0x80,0x00,0x05,0x80,0x00,0x05,0x80,0x00,0x05,0x80,0x00,0x05,
  0x70,0x00,0x05,0x10,0x00,0x05,0x10,0x00,0x01,0x0f,0xff,0xfe,0x00,0x00,0x00,
  0x00,0x00,0x00
};

static const unsigned char PROGMEM battery_33_bits[] = {
  0x00,0x00,0x00,0x0f,0xff,0xfe,0x10,0x00,0x01,0x10,0x00,0x6d,0x70,0x00,0x6d,
  0x80,0x00,0x6d,0x80,0x00,0x6d,0x80,0x00,0x6d,0x80,0x00,0x6d,0x80,0x00,0x6d,
  0x70,0x00,0x6d,0x10,0x00,0x6d,0x10,0x00,0x01,0x0f,0xff,0xfe,0x00,0x00,0x00,
  0x00,0x00,0x00
};

static const unsigned char PROGMEM battery_50_bits[] = {
  0x00,0x00,0x00,0x0f,0xff,0xfe,0x10,0x00,0x01,0x10,0x03,0x6d,0x70,0x03,0x6d,
  0x80,0x03,0x6d,0x80,0x03,0x6d,0x80,0x03,0x6d,0x80,0x03,0x6d,0x80,0x03,0x6d,
  0x70,0x03,0x6d,0x10,0x03,0x6d,0x10,0x00,0x01,0x0f,0xff,0xfe,0x00,0x00,0x00,
  0x00,0x00,0x00
};

static const unsigned char PROGMEM battery_67_bits[] = {
  0x00,0x00,0x00,0x0f,0xff,0xfe,0x10,0x00,0x01,0x10,0x1b,0x6d,0x70,0x1b,0x6d,
  0x80,0x1b,0x6d,0x80,0x1b,0x6d,0x80,0x1b,0x6d,0x80,0x1b,0x6d,0x80,0x1b,0x6d,
  0x70,0x1b,0x6d,0x10,0x1b,0x6d,0x10,0x00,0x01,0x0f,0xff,0xfe,0x00,0x00,0x00,
  0x00,0x00,0x00
};

static const unsigned char PROGMEM battery_83_bits[] = {
  0x00,0x00,0x00,0x0f,0xff,0xfe,0x10,0x00,0x01,0x10,0xdb,0x6d,0x70,0xdb,0x6d,
  0x80,0xdb,0x6d,0x80,0xdb,0x6d,0x80,0xdb,0x6d,0x80,0xdb,0x6d,0x80,0xdb,0x6d,
  0x70,0xdb,0x6d,0x10,0xdb,0x6d,0x10,0x00,0x01,0x0f,0xff,0xfe,0x00,0x00,0x00,
  0x00,0x00,0x00
};

static const unsigned char PROGMEM battery_full_bits[] = {
  0x00,0x00,0x00,0x0f,0xff,0xfe,0x10,0x00,0x01,0x16,0xdb,0x6d,0x76,0xdb,0x6d,
  0x86,0xdb,0x6d,0x86,0xdb,0x6d,0x86,0xdb,0x6d,0x86,0xdb,0x6d,0x86,0xdb,0x6d,
  0x76,0xdb,0x6d,0x16,0xdb,0x6d,0x10,0x00,0x01,0x0f,0xff,0xfe,0x00,0x00,0x00,
  0x00,0x00,0x00
};

// WiFi icon bitmaps (19x16 pixels)
static const unsigned char PROGMEM wifi_3_bars_bits[] = {
  0xfe,0x0f,0xe0,0xf9,0xf3,0xe0,0xe7,0xfc,0xe0,0xde,0x0f,0x60,0xb9,0xf3,0xa0,
  0x77,0xfd,0xc0,0xef,0x1e,0xe0,0xdc,0x07,0x60,0xf8,0xe3,0xe0,0xf3,0xb9,0xe0,
  0xfa,0x0b,0xe0,0xfc,0x47,0xe0,0xfe,0xaf,0xe0,0xff,0x1f,0xe0,0xff,0xbf,0xe0,
  0xff,0xff,0xe0
};

static const unsigned char PROGMEM wifi_4_bars_bits[] = {
  0xfe,0x0f,0xe0,0xf9,0xf3,0xe0,0xe7,0xfc,0xe0,0xde,0x0f,0x60,0xb8,0x43,0xa0,
  0x71,0xf1,0xc0,0xe7,0x1c,0xe0,0xcc,0x06,0x60,0xe8,0xe2,0xe0,0xf3,0xb9,0xe0,
  0xfa,0x0b,0xe0,0xfc,0x47,0xe0,0xfe,0xaf,0xe0,0xff,0x1f,0xe0,0xff,0xbf,0xe0,
  0xff,0xff,0xe0
};

static const unsigned char PROGMEM wifi_5_bars_bits[] = {
  0xfe,0x0f,0xe0,0xf8,0x43,0xe0,0xe1,0xf0,0xe0,0xce,0x0e,0x60,0x88,0x42,0x20,
  0x31,0xf1,0x80,0xa7,0x1c,0xa0,0xcc,0x06,0x60,0xe8,0xe2,0xe0,0xf3,0xb9,0xe0,
  0xfa,0x0b,0xe0,0xfc,0x47,0xe0,0xfe,0xaf,0xe0,0xff,0x1f,0xe0,0xff,0xbf,0xe0,
  0xff,0xff,0xe0
};

// Weather icon bitmaps
static const unsigned char PROGMEM weather_sun_bits[] = {  // 15x16
  0x01,0x00,0x21,0x08,0x10,0x10,0x03,0x80,0x8c,0x62,0x48,0x24,0x10,0x10,0x10,
  0x10,0x10,0x10,0x48,0x24,0x8c,0x62,0x03,0x80,0x10,0x10,0x21,0x08,0x01,0x00,
  0x00,0x00
};

static const unsigned char PROGMEM weather_cloud_sunny_bits[] = {  // 17x16
  0x00,0x20,0x00,0x02,0x02,0x00,0x00,0x70,0x00,0x01,0x8c,0x00,0x09,0x04,0x80,
  0x02,0x02,0x00,0x02,0x02,0x00,0x07,0x82,0x00,0x08,0x44,0x80,0x10,0x2c,0x00,
  0x30,0x30,0x00,0x60,0x1e,0x00,0x80,0x03,0x00,0x80,0x01,0x00,0x80,0x01,0x00,
  0x7f,0xfe,0x00
};

static const unsigned char PROGMEM weather_cloud_rain_bits[] = {  // 34x26
  0x00,0x00,0x03,0xe0,0x00,0x00,0x00,0x04,0x10,0x00,0x00,0x00,0x08,0x08,0x00,
  0x00,0x00,0x18,0x04,0x00,0x00,0x00,0x20,0x07,0x00,0x00,0x00,0x40,0x00,0x80,
  0x00,0x00,0x40,0x00,0x40,0x00,0x00,0x20,0x00,0x40,0x00,0x00,0x1f,0xff,0x80,
  0x00,0x00,0x00,0x88,0x00,0x00,0x00,0x11,0x11,0x00,0x00,0x00,0x22,0x42,0x00,
  0x00,0x00,0x48,0x94,0x00,0x00,0x00,0x11,0x20,0x00,0x00,0x00,0x00,0x40,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00
};

static const unsigned char PROGMEM weather_cloud_snow_bits[] = {  // 17x16
  0x00,0x00,0x00,0x07,0xc0,0x00,0x08,0x20,0x00,0x10,0x10,0x00,0x30,0x08,0x00,
  0x40,0x0e,0x00,0x80,0x01,0x00,0x80,0x00,0x80,0x40,0x00,0x80,0x3f,0xff,0x00,
  0x00,0x00,0x00,0x09,0x4a,0x00,0x20,0x00,0x00,0x08,0x90,0x00,0x22,0x44,0x00,
  0x00,0x00,0x00
};

static const unsigned char PROGMEM weather_cloud_lightning_bits[] = {  // 17x16
  0x00,0x00,0x00,0x07,0xc0,0x00,0x08,0x20,0x00,0x10,0x10,0x00,0x30,0x08,0x00,
  0x40,0x0e,0x00,0x80,0x81,0x00,0x81,0x00,0x80,0x43,0x00,0x80,0x26,0x3f,0x00,
  0x0f,0x80,0x00,0x01,0x80,0x00,0x03,0x00,0x00,0x02,0x00,0x00,0x04,0x00,0x00,
  0x00,0x00,0x00
};

static const unsigned char PROGMEM weather_wind_bits[] = {  // 15x16
  0x00,0x00,0x00,0x00,0x00,0x30,0x03,0x88,0x04,0x44,0x04,0x44,0x00,0x44,0x00,
  0x88,0xff,0x32,0x00,0x00,0xad,0x82,0x00,0x60,0x00,0x10,0x00,0x10,0x01,0x20,
  0x00,0xc0
};

// Select battery bitmap based on percentage
static const unsigned char* selectBatteryBitmap(uint8_t percentage) {
  if (percentage >= 92) return battery_full_bits;
  if (percentage >= 76) return battery_83_bits;
  if (percentage >= 59) return battery_67_bits;
  if (percentage >= 41) return battery_50_bits;
  if (percentage >= 17) return battery_33_bits;
  return battery_10_bits;
}

// Select WiFi bitmap based on RSSI (signal strength)
static const unsigned char* selectWifiBitmap(int rssi) {
  if (rssi >= -55) return wifi_5_bars_bits;  // Excellent
  if (rssi >= -67) return wifi_4_bars_bits;  // Good
  return wifi_3_bars_bits;                    // Fair/Weak
}

void StatusIconsDrawBattery(int16_t x, int16_t y, uint8_t percentage) {
  Adafruit_SSD1306& display = DisplayGetDisplay();
  const unsigned char* bitmap = selectBatteryBitmap(percentage);
  display.drawBitmap(x, y, bitmap, BATTERY_ICON_WIDTH, BATTERY_ICON_HEIGHT, 1);
}

void StatusIconsDrawWifi(int16_t x, int16_t y, int rssi) {
  Adafruit_SSD1306& display = DisplayGetDisplay();
  const unsigned char* bitmap = selectWifiBitmap(rssi);
  display.drawBitmap(x, y, bitmap, WIFI_ICON_WIDTH, WIFI_ICON_HEIGHT, 1);
}

void StatusIconsDrawWeather(int16_t x, int16_t y, uint8_t weatherCode) {
  Adafruit_SSD1306& display = DisplayGetDisplay();
  
  const unsigned char* bitmap = nullptr;
  uint8_t width = 17;
  uint8_t height = 16;
  
  switch(weatherCode) {
    case WEATHER_SUN:
      bitmap = weather_sun_bits;
      width = 15;
      break;
    case WEATHER_CLOUD_SUNNY:
      bitmap = weather_cloud_sunny_bits;
      width = 17;
      break;
    case WEATHER_CLOUD_RAIN:
      bitmap = weather_cloud_rain_bits;
      width = 34;
      height = 26;
      break;
    case WEATHER_CLOUD_SNOW:
      bitmap = weather_cloud_snow_bits;
      width = 17;
      break;
    case WEATHER_CLOUD_LIGHTNING:
      bitmap = weather_cloud_lightning_bits;
      width = 17;
      break;
    case WEATHER_WIND:
      bitmap = weather_wind_bits;
      width = 15;
      break;
    default:
      bitmap = weather_cloud_sunny_bits;  // Default fallback
      break;
  }
  
  if (bitmap) {
    display.drawBitmap(x, y, bitmap, width, height, 1);
  }
}
