#include "../h/BootLoader.h"
#include "hal/h/Display.h"
#include <Adafruit_GFX.h>

// User-friendly messages for first boot (AP setup mode)
static const char* firstBootMessages[] = {
  "Setting up WiFi...",
  "Starting web portal...",
  "Waiting for you...",
  "Loading settings...",
  "Preparing display...",
  "Checking for updates...",
  "All set! Starting..."
};

// User-friendly messages for normal boot
static const char* normalBootMessages[] = {
  "Loading settings...",
  "Connecting to WiFi...",
  "Syncing time...",
  "Loading services...",
  "Preparing display...",
  "Checking for updates...",
  "Ready!"
};

// Mode icon at top (same as SetupScreen)
static const unsigned char PROGMEM mode_icon_bits[] = {
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0f,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x0f,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x1f,0x8c,0x00,0x00,
  0x00,0x00,0x00,0x07,0xdf,0xbe,0x00,0x00,0x00,0x00,0x00,0x07,0xff,0xfe,0x00,0x00,
  0x00,0x00,0x00,0x07,0xff,0xfe,0x00,0x00,0x00,0x00,0x00,0x03,0xe0,0x7c,0x00,0x00,
  0x00,0x00,0x00,0x03,0xc0,0x3c,0x00,0x00,0x00,0x00,0x00,0x03,0x80,0x1c,0x00,0x00,
  0x00,0x00,0x00,0x1f,0x80,0x1f,0x80,0x00,0x00,0x00,0x00,0x3f,0x00,0x0f,0xc0,0x00,
  0x00,0x00,0x63,0x3f,0x00,0x0f,0xc0,0x00,0x00,0x00,0x77,0xbf,0x00,0x0f,0xc0,0x00,
  0x00,0x00,0xff,0x87,0x80,0x1e,0x00,0x00,0x00,0x01,0xff,0xc3,0x80,0x1c,0x00,0x00,
  0x00,0x07,0xc1,0xf3,0xc0,0x3c,0x00,0x00,0x00,0x07,0x80,0xf7,0xf0,0xfe,0x00,0x00,
  0x00,0x03,0x80,0x67,0xff,0xfe,0x00,0x00,0x00,0x01,0x80,0x67,0xff,0xfe,0x00,0x00,
  0x00,0x03,0x80,0x67,0x9f,0x9e,0x00,0x00,0x00,0x07,0x80,0xf0,0x0f,0x00,0x00,0x00,
  0x00,0x07,0xc1,0xf0,0x0f,0x00,0x00,0x00,0x00,0x01,0xff,0xc0,0x0f,0x00,0x00,0x00,
  0x00,0x00,0xff,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x77,0x80,0x00,0x00,0x00,0x00,
  0x00,0x00,0x63,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

void BootLoaderInit() {
  // Nothing to initialize
}

void BootLoaderShowStage(BootStage stage, bool isFirstBoot) {
  Adafruit_SSD1306& display = DisplayGetDisplay();
  display.clearDisplay();
  
  // Draw mode icon at top center
  display.drawBitmap(32, 5, mode_icon_bits, 64, 32, 1);
  
  // Calculate progress (0-112 pixels wide)
  int progress = (stage * 112) / BOOT_STAGE_COUNT;
  
  // Get message based on boot type
  const char* message = isFirstBoot ? firstBootMessages[stage] : normalBootMessages[stage];
  
  // Draw message text
  display.setTextColor(SSD1306_WHITE);
  display.setTextSize(1);
  display.setCursor(8, 45);
  display.print(message);
  
  // Draw progress bar frame (7px from left, 56px from top, 114px wide, 6px tall)
  display.drawRect(7, 56, 114, 6, 1);
  
  // Fill progress bar
  if (progress > 0) {
    display.fillRect(8, 57, progress, 4, 1);
  }
  
  display.display();
  delay(300);  // Brief pause so user can read
}

void BootLoaderComplete() {
  // Final display before transitioning to Time mode
  Adafruit_SSD1306& display = DisplayGetDisplay();
  display.clearDisplay();
  display.display();
}
